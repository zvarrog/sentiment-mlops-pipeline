# –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ–∑—é–º–µ: –£–ª—É—á—à–µ–Ω–Ω—ã–µ Airflow DAG

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. Parallel Pipeline (`kindle_pipeline_parallel.py`)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (—Å—Ö–µ–º–∞ + –∫–∞—á–µ—Å—Ç–≤–æ)
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ 3 –º–æ–¥–µ–ª–µ–π: LogReg, RandomForest, GradientBoosting
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –ø–æ F1-macro
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~15-20 –º–∏–Ω—É—Ç (vs ~30 –º–∏–Ω—É—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
artefacts/
‚îú‚îÄ‚îÄ best_model.joblib                    ‚Üê –õ—É—á—à–∞—è –º–æ–¥–µ–ª—å
‚îî‚îÄ‚îÄ model_artefacts/
    ‚îú‚îÄ‚îÄ model_logreg.joblib              ‚Üê –í—Å–µ —Ç—Ä–∏ –º–æ–¥–µ–ª–∏
    ‚îú‚îÄ‚îÄ model_rf.joblib
    ‚îú‚îÄ‚îÄ model_hist_gb.joblib
    ‚îú‚îÄ‚îÄ meta_logreg.json                 ‚Üê –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–π
    ‚îú‚îÄ‚îÄ meta_rf.json
    ‚îú‚îÄ‚îÄ meta_hist_gb.json
    ‚îî‚îÄ‚îÄ best_model_meta.json             ‚Üê –§–∏–Ω–∞–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
```

---

### 2. Monitored Pipeline (`kindle_pipeline_monitored.py`)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏ –≤ PostgreSQL
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ (success/failed/skipped)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –º–æ–¥–µ–ª–µ–π (val_f1_macro, test_f1_macro, accuracy)
- –ö–æ–ª–±–µ–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö metrics:**
```sql
-- –¢–∞–±–ª–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫ –∑–∞–¥–∞—á
task_metrics (
    dag_id, task_id, execution_date,
    duration_sec, status, created_at
)

-- –¢–∞–±–ª–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫ –º–æ–¥–µ–ª–µ–π
model_metrics (
    dag_id, execution_date, model_name,
    metric_name, metric_value, split
)
```

**–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:**
```sql
-- –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á
SELECT task_id, AVG(duration_sec) 
FROM task_metrics 
GROUP BY task_id;

-- –¢—Ä–µ–Ω–¥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
SELECT execution_date::date, AVG(metric_value)
FROM model_metrics
WHERE metric_name = 'val_f1_macro'
GROUP BY execution_date::date;
```

---

### 3. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

1. `postgres-init/02-init-metrics-db.sql` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü metrics
2. `postgres-init/00-init-multiple-databases.sh` ‚Äî —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ë–î
3. `docker-compose.yml` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ:
   - `POSTGRES_MULTIPLE_DATABASES=airflow_meta,metrics`
   - `AIRFLOW_CONN_METRICS_DB=postgresql://admin:admin@postgres:5432/metrics`

**–ù–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**

1. `airflow/dags/README_NEW_DAGS.md` ‚Äî –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ DAG
2. `QUICK_START_NEW_DAGS.md` ‚Äî –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
3. `IMPLEMENTATION_NEW_DAGS.md` ‚Äî –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
4. `tests/test_new_dags.py` ‚Äî —Ç–µ—Å—Ç—ã

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ Parallel Pipeline

```bash
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
docker-compose down -v
docker-compose build --no-cache
docker-compose up -d

# –¢—Ä–∏–≥–≥–µ—Ä —á–µ—Ä–µ–∑ CLI
docker exec -it sentiment-mlops-pipeline-airflow-1 \
  airflow dags trigger kindle_reviews_parallel_pipeline

# –ò–ª–∏ —á–µ—Ä–µ–∑ UI
http://localhost:8080 ‚Üí kindle_reviews_parallel_pipeline ‚Üí Trigger
```

### –ó–∞–ø—É—Å–∫ Monitored Pipeline

```bash
# –¢—Ä–∏–≥–≥–µ—Ä
docker exec -it sentiment-mlops-pipeline-airflow-1 \
  airflow dags trigger kindle_reviews_monitored_pipeline

# –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ç—Ä–∏–∫
docker exec -it sentiment-mlops-pipeline-postgres-1 \
  psql -U admin -d metrics

# SQL –∑–∞–ø—Ä–æ—Å
SELECT * FROM task_metrics ORDER BY created_at DESC LIMIT 10;
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ DAG

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Base | Parallel | Monitored |
|----------|------|----------|-----------|
| **–í—Ä–µ–º—è** | ~30 –º–∏–Ω | ~15-20 –º–∏–Ω | ~20-30 –º–∏–Ω |
| **–ú–æ–¥–µ–ª–∏** | 1 (Optuna) | 3 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ | 1 (Optuna) |
| **Trials** | ~50 | ~10 –Ω–∞ –º–æ–¥–µ–ª—å | ~50 |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è** | –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ | –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** | MLflow | MLflow | MLflow + –ë–î |
| **Use Case** | Production | –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã | –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ |

---

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### Parallel Pipeline

1. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–¥–∞—á** ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Airflow dependencies –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
2. **–ú–µ–Ω—å—à–µ trials** ‚Äî 10 –≤–º–µ—Å—Ç–æ 50 –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏ (—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 3-5 —Ä–∞–∑)
3. **XCom –¥–ª—è –æ–±–º–µ–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏** ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞ –º–µ—Ç—Ä–∏–∫ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä** ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –µ–¥–∏–Ω–æ–π –º–µ—Ç—Ä–∏–∫–µ val_f1_macro

### Monitored Pipeline

1. **–ö–æ–ª–±–µ–∫–∏ –≤–º–µ—Å—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ü–∏–∏** ‚Äî `on_success_callback`/`on_failure_callback` –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –∫–æ–¥
2. **–û—Ç–¥–µ–ª—å–Ω–∞—è –ë–î** ‚Äî metrics –Ω–µ –∑–∞—Å–æ—Ä—è–µ—Ç airflow_meta
3. **–î–≤–µ —Ç–∞–±–ª–∏—Ü—ã** ‚Äî —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∑–∞–¥–∞—á –∏ –º–æ–¥–µ–ª–µ–π
4. **UPSERT –≤–º–µ—Å—Ç–æ INSERT** ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ

---

## ‚ú® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **–ë—ã—Å—Ç—Ä–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π** —á–µ—Ä–µ–∑ parallel pipeline
- **–ú–µ–Ω—å—à–µ –æ–∂–∏–¥–∞–Ω–∏—è** –ø—Ä–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞—Ö
- **–í—Å–µ –º–æ–¥–µ–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã** –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

### –î–ª—è production
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç—Ä–µ–Ω–¥–æ–≤** —á–µ—Ä–µ–∑ SQL
- **–ê–ª–µ—Ä—Ç–∏–Ω–≥** –ø—Ä–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫ (–ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å)

### –î–ª—è MLOps
- **–ü–æ–ª–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** –ø–∞–π–ø–ª–∞–π–Ω–∞
- **–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π** –≤ –ë–î
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI-—Å–∏—Å—Ç–µ–º–∞–º–∏** —á–µ—Ä–µ–∑ SQL

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–ê–ª–µ—Ä—Ç–∏–Ω–≥** ‚Äî Slack/Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –º–µ—Ç—Ä–∏–∫
2. **–î–∞—à–±–æ—Ä–¥** ‚Äî Grafana –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ metrics
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ** ‚Äî A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
4. **Scheduled –∑–∞–ø—É—Å–∫–∏** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI/CD** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏

---

## üêõ Troubleshooting

### –ë–∞–∑–∞ metrics –Ω–µ —Å–æ–∑–¥–∞–ª–∞—Å—å

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs sentiment-mlops-pipeline-postgres-1

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
docker-compose down -v
docker-compose up -d
```

### Connection metrics_db –Ω–µ –Ω–∞–π–¥–µ–Ω

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
docker exec sentiment-mlops-pipeline-airflow-1 env | grep METRICS

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
AIRFLOW_CONN_METRICS_DB=postgresql://admin:admin@postgres:5432/metrics
```

### DAG –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ UI

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
docker exec sentiment-mlops-pipeline-airflow-1 \
  python -c "from airflow.dags.kindle_pipeline_parallel import dag; print(dag.dag_id)"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å scheduler
docker-compose restart airflow
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ**: `airflow/dags/README_NEW_DAGS.md`
- **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç**: `QUICK_START_NEW_DAGS.md`
- **–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: `IMPLEMENTATION_NEW_DAGS.md`
- **–û—Å–Ω–æ–≤–Ω–æ–π README**: `README.md` (–æ–±–Ω–æ–≤–ª–µ–Ω)

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] Parallel pipeline —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [x] Monitored pipeline —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [x] –ë–î metrics –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
- [x] docker-compose.yml –æ–±–Ω–æ–≤–ª–µ–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [x] –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- [x] README –æ–±–Ω–æ–≤–ª–µ–Ω
- [x] –ü—Ä–∏–º–µ—Ä—ã SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω—ã

---

**–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ –∫ production** ‚ú®
